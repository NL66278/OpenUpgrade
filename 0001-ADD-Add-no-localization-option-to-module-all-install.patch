From 9c38bbb41d564f51fc387782a9dbc51fc2099af0 Mon Sep 17 00:00:00 2001
From: Ronald Portier <ronald@therp.nl>
Date: Tue, 30 May 2017 15:02:34 +0200
Subject: [PATCH] [ADD] Add no localization option to module all install.

---
 .../model/install_all_wizard.py                    | 132 ++++++++++++---------
 .../view/install_all_wizard.xml                    |  62 ++++++----
 2 files changed, 120 insertions(+), 74 deletions(-)

diff --git a/odoo/addons/openupgrade_records/model/install_all_wizard.py b/odoo/addons/openupgrade_records/model/install_all_wizard.py
index 01baf7e..d641881 100644
--- a/odoo/addons/openupgrade_records/model/install_all_wizard.py
+++ b/odoo/addons/openupgrade_records/model/install_all_wizard.py
@@ -1,4 +1,5 @@
 # -*- coding: utf-8 -*-
 # Copyright 2011-2015 Therp BV <https://therp.nl>
 # Copyright 2016 Opener B.V. <https://opener.am>
+# Â© 2012-2017 Therp BV <http://therp.nl>
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
@@ -6,8 +6,16 @@
 from odoo import api, fields, models
 from odoo.modules.registry import Registry
 from odoo.addons.openupgrade_records.blacklist import BLACKLIST_MODULES
+from openerp.tools.translate import _
+
+
+STATE_SELECTION = [
+    ('init', 'init'),
+    ('confirm', 'confirm'),
+    ('ready', 'ready'),
+]


 class install_all_wizard(TransientModel):
@@ -41,33 +27,22 @@ class install_all_wizard(TransientModel):
     _description = 'OpenUpgrade Install All Wizard'
     _columns = {
         'state': fields.selection(
-            [('init', 'init'), ('ready', 'ready')], 'State', readonly=True),
+            STATE_SELECTION,
+            'State',
+            readonly=True,
+        ),
+        'no_localization': fields.boolean(
+            string='Do not install localization modules',
+            readonly=True,
+            states={'init': [('readonly', False)]}
+        ),
         'to_install': fields.integer(
             'Number of modules to install', readonly=True),
         }
     _defaults = {
         'state': lambda *a: 'init',
-        }
-
-    def default_get(self, cr, uid, fields, context=None):
-        """
-        Update module list and retrieve the number
-        of installable modules
-        """
-        res = super(install_all_wizard, self).default_get(
-            cr, uid, fields, context=None)
-        module_obj = self.pool.get('ir.module.module')
-        update, add = module_obj.update_list(cr, uid,)
-        print "%s modules added" % add
-        module_ids = module_obj.search(
-            cr, uid, [
-                ('state', 'not in',
-                 ['installed', 'uninstallable', 'unknown'])
-                ])
-        res.update(
-            {'to_install': module_ids and len(module_ids) or False}
-            )
-        return res
+        'no_localization': True,
+    }

     def quirk_fiscalyear(self, cr, uid, ids, context=None):
         """
@@ -105,23 +80,72 @@ class install_all_wizard(TransientModel):
                 'date_stop': "%s-12-31" % time.strftime('%Y'),
                 })

+    def _get_module_domain(self, no_localization):
+        module_domain = [
+            ('state', 'not in',
+                ['installed', 'uninstallable', 'unknown']),
+            ('category_id.name', '!=', 'Tests'),
+            ('name', 'not in', BLACKLIST_MODULES),
+        ]
+        if no_localization:
+            module_domain.append(('name', 'not like', 'l10n_'))
+        return module_domain
+
+    def redisplay_wizard_screen(self, cr, uid, ids, context=None):
+        """Redisplay wizardscreen."""
+        return {
+            'name': _('Install (nearly) all modules'),
+            'view_type': 'form',
+            'view_mode': 'form',
+            'views': [(False, 'form')],
+            'res_model': self._name,
+            'res_id': ids[0],
+            'type': 'ir.actions.act_window',
+            'target': 'new',
+        }
+
+    def confirm_install(self, cr, uid, ids, context=None):
+        """Show users number of modules to be installed."""
+        user_input = self.browse(cr, uid, ids, context=context)[0]
+        module_obj = self.pool.get('ir.module.module')
+        update, add = module_obj.update_list(cr, uid,)
+        module_domain = self._get_module_domain(user_input.no_localization)
+        module_count = module_obj.search_count(
+            cr, uid, module_domain, context=context
+        )
+        if module_count:
+            self.write(
+                cr, uid, ids, {
+                    'state': 'confirm',
+                    'to_install': module_count,
+                },
+                context=context
+            )
+        else:
+            self.write(
+                cr, uid, ids, {
+                    'state': 'ready',
+                    'to_install': module_count,
+                },
+                context=context
+            )
+        return self.redisplay_wizard_screen(cr, uid, ids, context=context)
+
     def install_all(self, cr, uid, ids, context=None):
         """
         Main wizard step. Set all installable modules to install
         and actually install them. Exclude testing modules.
         """
+        user_input = self.browse(cr, uid, ids, context=context)[0]
         module_obj = self.pool.get('ir.module.module')
+        module_domain = self._get_module_domain(user_input.no_localization)
         module_ids = module_obj.search(
-            cr, uid, [
-                ('state', 'not in',
-                 ['installed', 'uninstallable', 'unknown']),
-                ('category_id.name', '!=', 'Tests'),
-                ('name', 'not in', BLACKLIST_MODULES),
-                ], context=context)
+            cr, uid, module_domain, context=context
+        )
         if module_ids:
             module_obj.write(
                 cr, uid, module_ids, {'state': 'to install'}, context=context)
             cr.commit()
             _db, pool = pooler.restart_pool(cr.dbname, update_module=True)
-            self.write(cr, uid, ids, {'state': 'ready'}, context)
-        return True
+        self.write(cr, uid, ids, {'state': 'ready'}, context)
+        return self.redisplay_wizard_screen(cr, uid, ids, context=context)
diff --git a/odoo/addons/openupgrade_records/view/install_all_wizard.xml b/odoo/addons/openupgrade_records/view/install_all_wizard.xml
index 3dc93eb..cd972fb 100644
--- a/odoo/addons/openupgrade_records/view/install_all_wizard.xml
+++ b/odoo/addons/openupgrade_records/view/install_all_wizard.xml
@@ -7,28 +7,50 @@
             <field name="type">form</field>
             <field name="arch" type="xml">
                 <form string="OpenUpgrade Install All Modules Wizard" version="6.1">
-                    <group states="init" colspan="4">
-                        <label string="This will install all modules on the database. Do not continue if you use this database in production." colspan="4"
-                               />
-                        <field name="to_install"/>
-                        <newline/>
-                        <button icon="gtk-close"
-                                special="cancel"
-                                string="Cancel"
+                    <group colspan="4" col="4">
+                        <field name="state" invisible="1"/>
+                        <group states="init" colspan="4" col="4">
+                            <label
+                                string="This will install all modules on the database. Do not continue if you use this database in production."
+                                colspan="4"
                                 />
-                        <button icon="gtk-ok"
-                                string="Continue"
-                                name="install_all"
-                                type="object"
+                        </group>
+                        <group states="confirm" colspan="4" col="4">
+                            <label
+                                string="Confirm the installation of the modules."
+                                colspan="4"
                                 />
-                    </group>
-                    <group states="ready" colspan="4">
-                        <label string="Modules installed"
-                               />
-                        <field name="state" invisible="1"/>
-                        <button icon="gtk-close"
-                                special="cancel"
-                                string="Close"
+                        </group>
+                        <group states="ready" colspan="4" col="4">
+                            <label
+                                string="Modules installed."
+                                colspan="4"
+                                />
+                        </group>
+                        <field name="no_localization"/>
+                        <field
+                            name="to_install"
+                            attrs="{'invisible': [('state', '=', 'init')]}"
+                            />
+                        <newline/>
+                        <button
+                            icon="gtk-close"
+                            special="cancel"
+                            string="Cancel"
+                        />
+                        <button
+                            icon="gtk-ok"
+                            string="Continue"
+                            name="confirm_install"
+                            type="object"
+                            states="init"
+                            />
+                        <button
+                            icon="gtk-ok"
+                            string="Continue"
+                            name="install_all"
+                            type="object"
+                            states="confirm"
                             />
                     </group>
                 </form>
--
2.1.4

